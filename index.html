<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Exercises</title>

    <link rel="manifest" href="./manifest.json">
    <script>
      if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("./service-worker.js");
      }
    </script>

    <style>
      :root { --gap:16px; --r:14px; font-family: -apple-system, system-ui, "SF Pro Text", Arial, sans-serif; }
      body { margin:0; background:#0b0b0f; color:#fff; }
      .wrap { padding: max(env(safe-area-inset-top),24px) max(env(safe-area-inset-right),24px) max(env(safe-area-inset-bottom),24px) max(env(safe-area-inset-left),24px); }
      h1 { margin:0 0 14px; font-size:22px; }
      .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: var(--gap); }
      .tile { background:#14141c; border-radius: var(--r); padding:18px; text-align:center; color:#fff; text-decoration:none;
              box-shadow: 0 10px 30px rgba(0,0,0,.35); transition: transform .08s ease; }
      .tile:active { transform: scale(.98); }
      .emoji { font-size:42px; display:block; margin-bottom:8px; }
      .sub { opacity:.75; font-size:12px; margin-top:4px; }
      .tiny { opacity:.6; font-size:12px; margin-top:6px; }

      .card { max-width: 560px; margin: 0 auto; background:#14141c; border-radius: var(--r); padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
      .back { display:inline-block; margin-bottom:14px; color:#9aa1ff; text-decoration:none; }
      .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .muted { opacity:.75; font-size:13px; }
      .stepper { display:flex; align-items:center; gap:12px; margin-top: 8px; }
      .btn { border:0; border-radius:12px; padding:14px 18px; background:#1f2030; color:#fff; font-size:20px; line-height:1; transition: transform .1s ease, background .2s ease; }
      .btn:active { transform: scale(0.97); }
      .count { font-variant-numeric: tabular-nums; font-size:42px; min-width: 4.5ch; text-align:center; }
      label { display:block; margin:18px 0 6px; opacity:.85; }
      input[type="text"] { width:100%; font-size:18px; padding:12px 14px; border-radius:10px; border:1px solid #2a2b3f; background:#0f1020; color:#fff; }
      input[type="date"] { font-size:14px; padding:10px 12px; border-radius:10px; border:1px solid #2a2b3f; background:#0f1020; color:#fff; }
      .note { opacity:.7; font-size:13px; margin-top:12px; min-height:1em; transition:opacity .2s; }
      .chart-wrap { margin-top:18px; background:#10111d; border:1px solid #2a2b3f; border-radius:12px; padding:12px; }
      canvas { width:100%; height:180px; display:block; cursor:grab; touch-action:none; }
      .toolbar { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
      .toolbar-btn { border:0; border-radius:10px; padding:10px 16px; background:#1f2030; color:#fff; font-size:14px; cursor:pointer; transition: transform .1s ease, background .2s ease; }
      .toolbar-btn:hover { background:#2a2b4f; }
      .toolbar-btn:active { transform: scale(0.97); }
      .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(110px,1fr)); gap:10px; margin-top:14px; }
      .stat { background:#10111d; border:1px solid #2a2b3f; border-radius:10px; padding:12px; text-align:center; }
      .stat-val { font-size:22px; font-weight:600; font-variant-numeric:tabular-nums; }
      .stat-label { font-size:11px; opacity:.6; margin-top:4px; }
      .stat-arrow-up { color:#4ade80; }
      .stat-arrow-down { color:#f87171; }
      .stat-arrow-same { color:#9aa1ff; }
      .fade { animation: fade .18s ease; } @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
      html, body { touch-action: manipulation; }
      .btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    </style>
  </head>
  <body>
    <div class="wrap" id="app"></div>

    <script>
      /* ====== CONFIG: your back-friendly exercise set ====== */
      const EXERCISES = [
          /* Stretches ‚Äî daily: neural tone resets overnight, no tissue damage */
          {id:"hip-flexor-stretch", name:"Half-Kneeling Hip-Flexor Stretch", emoji:"ü¶µ", unit:"sec",  dpw:7},
          {id:"hamstring-stretch",  name:"Supine Hamstring Stretch",         emoji:"üßò", unit:"sec",  dpw:7},
          {id:"figure4-stretch",    name:"Figure-4 Piriformis Stretch",      emoji:"üßò", unit:"sec",  dpw:7},

          /* Motor control ‚Äî daily: neural pattern training, not strength */
          {id:"side-plank",         name:"Side Plank",           emoji:"üß±", unit:"sec",  dpw:7},
          {id:"bird-dog",           name:"Bird-Dog",             emoji:"üê∂", unit:"reps", dpw:7},
          {id:"mcgill-curlup",      name:"McGill Curl-Up",       emoji:"üõèÔ∏è", unit:"reps", dpw:7},
          {id:"dead-bug",           name:"Dead Bug",             emoji:"ü™≤", unit:"reps", dpw:7},
          {id:"cat-camel",          name:"Cat‚ÄìCamel",            emoji:"üêà", unit:"reps", dpw:7},

          /* Rehab strengthening ‚Äî 5x/week: low-load but benefits from recovery */
          {id:"suitcase-carry",     name:"Suitcase Carry",       emoji:"üß≥", unit:"sec",  dpw:5},
          {id:"glute-bridge",       name:"Glute Bridge",         emoji:"üåâ", unit:"reps", dpw:5},
          {id:"clamshell",          name:"Clamshell",            emoji:"üêö", unit:"reps", dpw:5},
          {id:"draken",             name:"Draken",               emoji:"üêâ", unit:"reps", dpw:5},
          {id:"hip-adduction",      name:"Hip Adduction",        emoji:"ü¶ø", unit:"reps", dpw:5},
          {id:"rubber-band-archer", name:"Rubber Band Archer Pull", emoji:"üèπ", unit:"reps", dpw:5},
          {id:"rubber-band-row",    name:"Rubber Band Row",      emoji:"üö£", unit:"reps", dpw:5},

          /* Strength & conditioning ‚Äî 3x/week: needs 48-72h recovery */
          {id:"running",            name:"Running",              emoji:"üèÉ", unit:"100m", dpw:3},
          {id:"swimming",           name:"Swimming",             emoji:"üèä", unit:"100m", dpw:3},
          {id:"skiing",             name:"Skiing",               emoji:"‚õ∑Ô∏è", unit:"km",   dpw:3},
          {id:"pushups",            name:"Push-Ups",             emoji:"ü§∏", unit:"reps", dpw:3},
          {id:"pullups",            name:"Pull-Ups",             emoji:"üßó", unit:"reps", dpw:3}
      ];

      const WINDOW_DAYS = 14; // visible window size
      const MS_PER_DAY = 86400000;

      const app = document.getElementById('app');
      const todayStr = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD (UTC)
      const esc = (s) => (s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      const addDays = (d, n) => { const dt = new Date(d); dt.setUTCDate(dt.getUTCDate()+n); return dt; };
      const isoDate = (d) => new Date(d).toISOString().slice(0,10);
      const clamp = (v,min,max) => Math.min(max, Math.max(min, v));

      function keysFor(id, date) {
          return {
              count: `ex:${id}:${date}:count`,
              notes: `ex:${id}:${date}:notes`
          };
      }
      function daysBetween(a, b) {
          const A = new Date(a), B = new Date(b);
          const aa = Date.UTC(A.getUTCFullYear(), A.getUTCMonth(), A.getUTCDate());
          const bb = Date.UTC(B.getUTCFullYear(), B.getUTCMonth(), B.getUTCDate());
          return Math.floor((bb - aa) / MS_PER_DAY);
      }
      function parseDateKey(k, id) {
          const pfx = `ex:${id}:`, sfx = `:count`;
          if (!k.startsWith(pfx) || !k.endsWith(sfx)) return null;
          const ds = k.slice(pfx.length, -sfx.length);
          return /^\d{4}-\d{2}-\d{2}$/.test(ds) ? ds : null;
      }

      /* ====== DATA UTILITIES (shared by analytics, export, etc.) ====== */
      function getAllDataForExercise(id) {
          const result = {};
          for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              if (!k) continue;
              const ds = parseDateKey(k, id);
              if (ds) {
                  const v = parseInt(localStorage.getItem(k) || "0", 10);
                  if (v > 0) result[ds] = v;
              }
          }
          return result;
      }

      function getAllData() {
          const result = {};
          for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              if (!k || !k.startsWith('ex:')) continue;
              result[k] = localStorage.getItem(k);
          }
          return result;
      }

      function getStreak(id) {
          const data = getAllDataForExercise(id);
          const today = todayStr();
          let current = 0, best = 0, run = 0;
          // Walk backwards from today
          let d = today;
          // Allow streak to start from today or yesterday
          const todayVal = data[today] || 0;
          const yesterdayVal = data[isoDate(addDays(new Date(today), -1))] || 0;
          if (todayVal === 0 && yesterdayVal === 0) { return { current: 0, best: 0 }; }
          const startOffset = todayVal > 0 ? 0 : 1;
          for (let i = startOffset; i < 3650; i++) {
              const ds = isoDate(addDays(new Date(today), -i));
              if (data[ds]) { current++; } else { break; }
          }
          // Best streak: scan all dates sorted
          const dates = Object.keys(data).sort();
          for (let i = 0; i < dates.length; i++) {
              if (i === 0 || daysBetween(dates[i-1], dates[i]) === 1) {
                  run++;
              } else {
                  run = 1;
              }
              if (run > best) best = run;
          }
          return { current, best };
      }

      function getWeekTotal(id, weeksAgo) {
          const today = new Date(todayStr());
          const dow = today.getUTCDay(); // 0=Sun
          const endOfWeek = addDays(today, -dow - (weeksAgo * 7));
          const startOfWeek = addDays(endOfWeek, -6);
          let total = 0;
          for (let i = 0; i < 7; i++) {
              const ds = isoDate(addDays(startOfWeek, i));
              const v = parseInt(localStorage.getItem(keysFor(id, ds).count) || "0", 10);
              if (!isNaN(v)) total += v;
          }
          return total;
      }

      function getAllTimeTotal(id) {
          const data = getAllDataForExercise(id);
          return Object.values(data).reduce((s, v) => s + v, 0);
      }

      function getWeekDays(id, weeksAgo) {
          const today = new Date(todayStr());
          const dow = today.getUTCDay();
          const endOfWeek = addDays(today, -dow - (weeksAgo * 7));
          const startOfWeek = addDays(endOfWeek, -6);
          let days = 0;
          for (let i = 0; i < 7; i++) {
              const ds = isoDate(addDays(startOfWeek, i));
              const v = parseInt(localStorage.getItem(keysFor(id, ds).count) || "0", 10);
              if (v > 0) days++;
          }
          return days;
      }

      /* ====== EXPORT / IMPORT ====== */
      function exportData() {
          const data = getAllData();
          const payload = {
              version: 1,
              exported: new Date().toISOString(),
              entries: Object.keys(data).length,
              data: data
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `exercises-backup-${todayStr()}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }

      function importData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.addEventListener('change', () => {
              const file = input.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = () => {
                  try {
                      const payload = JSON.parse(reader.result);
                      if (!payload.data || typeof payload.data !== 'object') {
                          alert('Invalid backup file: missing data.');
                          return;
                      }
                      const keys = Object.keys(payload.data).filter(k => k.startsWith('ex:'));
                      if (keys.length === 0) {
                          alert('No exercise data found in file.');
                          return;
                      }
                      // Count new vs existing
                      let newCount = 0, overwriteCount = 0;
                      for (const k of keys) {
                          const existing = localStorage.getItem(k);
                          if (existing === null) newCount++;
                          else if (existing !== payload.data[k]) overwriteCount++;
                      }
                      let msg = `Found ${keys.length} entries.\n\n`;
                      msg += `  ${newCount} new entries will be added.\n`;
                      if (overwriteCount > 0) {
                          msg += `  ${overwriteCount} existing entries differ and will be OVERWRITTEN.\n`;
                      }
                      msg += `\nProceed?`;
                      if (!confirm(msg)) return;
                      for (const k of keys) {
                          localStorage.setItem(k, payload.data[k]);
                      }
                      alert(`Imported ${keys.length} entries.`);
                      route(); // re-render
                  } catch (e) {
                      alert('Failed to read backup file: ' + e.message);
                  }
              };
              reader.readAsText(file);
          });
          input.click();
      }

      /* ---------- HOME ---------- */
      function renderHome() {
          document.title = "Exercises";
          const today = todayStr();

          const tiles = EXERCISES.map(x => {
              const count = parseInt(localStorage.getItem(keysFor(x.id, today).count) || "0", 10);
              const tiny = `Today: ${isNaN(count)?0:count} ${x.unit}`;
              return `
      <a class="tile" href="#${x.id}" aria-label="${x.name}">
        <span class="emoji">${x.emoji}</span>
        <div>${x.name}</div>
        <div class="sub">${x.unit}</div>
        <div class="tiny">${tiny}</div>
      </a>
    `;
          }).join('');

          app.innerHTML = `
    <h1>Exercises</h1>
    <div class="toolbar">
      <button class="toolbar-btn" id="btn-export">Export Backup</button>
      <button class="toolbar-btn" id="btn-import">Import Backup</button>
    </div>
    <div class="grid fade">${tiles}</div>
  `;
          document.getElementById('btn-export').addEventListener('click', exportData);
          document.getElementById('btn-import').addEventListener('click', importData);
      }

      /* ---------- DETAIL (pannable chart, reversed direction) ---------- */
      function renderDetail(id) {
          const ex = EXERCISES.find(e => e.id === id);
          if (!ex) { location.hash = ""; return; }

          const date = todayStr();
          const k = keysFor(id, date);
          const count = parseInt(localStorage.getItem(k.count) || "0", 10);
          const notes = localStorage.getItem(k.notes) || "";

          document.title = `${ex.name}`;

          app.innerHTML = `
    <a class="back" href="#">‚Üê All exercises</a>
    <div class="card fade">
      <div class="row">
        <h1 style="margin:0">${ex.emoji} ${ex.name}</h1>
        <div class="muted">
          <label for="day" style="display:block;margin:0 0 4px;">Date</label>
          <input id="day" type="date" value="${date}">
        </div>
      </div>

      <div class="stepper" style="margin-top:12px;">
        <button class="btn" id="minus" aria-label="decrease">‚Äì</button>
        <div class="count" id="count" role="status" aria-live="polite">${isNaN(count)?0:count}</div>
        <button class="btn" id="plus" aria-label="increase">+</button>
        <div class="muted" style="margin-left:auto">${ex.unit}</div>
      </div>

      <label for="notes">Notes (optional)</label>
      <input id="notes" type="text" placeholder="sets √ó reps, comments" value="${esc(notes)}">
      <div class="note" id="status">Saved</div>

      <div class="chart-wrap">
        <div class="muted" id="rangeLabel" style="margin:0 0 8px;"></div>
        <canvas id="chart" width="600" height="200"></canvas>
      </div>

      <div class="stats" id="stats"></div>
    </div>`;

          // --- wiring ---
          const $count  = document.getElementById('count');
          const $minus  = document.getElementById('minus');
          const $plus   = document.getElementById('plus');
          const $notes  = document.getElementById('notes');
          const $status = document.getElementById('status');
          const $day    = document.getElementById('day');
          const $chart  = document.getElementById('chart');
          const $label  = document.getElementById('rangeLabel');
          const $stats  = document.getElementById('stats');

          const showSaved = () => { $status.textContent = 'Saved'; $status.style.opacity='1'; setTimeout(()=>{$status.style.opacity='.7';},250); };

          function updateStats() {
              const streak = getStreak(id);
              const thisWeek = getWeekTotal(id, 0);
              const lastWeek = getWeekTotal(id, 1);
              const total = getAllTimeTotal(id);
              const weekDays = getWeekDays(id, 0);
              const diff = thisWeek - lastWeek;
              const arrow = diff > 0 ? '<span class="stat-arrow-up">&#9650;</span>' : diff < 0 ? '<span class="stat-arrow-down">&#9660;</span>' : '<span class="stat-arrow-same">&#9654;</span>';
              const freqLabel = ex.dpw === 7 ? 'daily' : `${ex.dpw}x/wk`;
              $stats.innerHTML = `
                <div class="stat"><div class="stat-val">${streak.current}</div><div class="stat-label">Streak (days)</div></div>
                <div class="stat"><div class="stat-val">${streak.best}</div><div class="stat-label">Best streak</div></div>
                <div class="stat"><div class="stat-val">${weekDays}/${ex.dpw}</div><div class="stat-label">This wk (${freqLabel})</div></div>
                <div class="stat"><div class="stat-val">${arrow} ${thisWeek}</div><div class="stat-label">Wk vol (prev ${lastWeek})</div></div>
                <div class="stat"><div class="stat-val">${total}</div><div class="stat-label">All-time ${ex.unit}</div></div>
              `;
          }

          function storage(dateStr) { return keysFor(id, dateStr); }
          function loadFor(dateStr) {
              const kk = storage(dateStr);
              const c = parseInt(localStorage.getItem(kk.count) || "0", 10);
              const n = localStorage.getItem(kk.notes) || "";
              $count.textContent = isNaN(c) ? 0 : c;
              $notes.value = n;
              showSaved();
              computeBounds();
              drawHistory();
              updateStats();
          }
          function saveCount(dateStr, n) {
              localStorage.setItem(storage(dateStr).count, String(n));
              showSaved();
              computeBounds();
              drawHistory();
              updateStats();
          }
          function saveNotes(dateStr, v) {
              localStorage.setItem(storage(dateStr).notes, v);
              showSaved();
          }

          $plus.addEventListener('click', () => {
              const n = parseInt($count.textContent,10) + 1;
              $count.textContent = n; saveCount($day.value, n);
          }, {passive:true});

          $minus.addEventListener('click', () => {
              const n = Math.max(0, parseInt($count.textContent,10) - 1);
              $count.textContent = n; saveCount($day.value, n);
          }, {passive:true});

          let t; $notes.addEventListener('input', (e) => {
              clearTimeout(t); t = setTimeout(()=>saveNotes($day.value, e.target.value), 120);
          });

          $day.addEventListener('change', () => loadFor($day.value));

          // --- history window + panning state ---
          let earliest = todayStr();
          let latest = todayStr();
          let maxOffsetDays = 0;
          let offsetDays = 0;   // 0 = window ends today; larger = older window
          let pxPerDay = 8;

          function computeBounds() {
              let minDS = todayStr(), hasAny = false;
              for (let i=0;i<localStorage.length;i++) {
                  const k = localStorage.key(i);
                  if (!k) continue;
                  const ds = parseDateKey(k, id);
                  if (ds) { hasAny = true; if (ds < minDS) minDS = ds; }
              }
              const today = todayStr();
              earliest = hasAny ? minDS : today;
              latest = today;
              maxOffsetDays = Math.max(0, daysBetween(earliest, latest) - (WINDOW_DAYS - 1));
              offsetDays = clamp(offsetDays, 0, maxOffsetDays);
          }

          function getHistoryWindow(endISO, days) {
              const end = new Date(endISO);
              const start = addDays(end, -(days-1));
              const labels = [];
              const values = [];
              for (let i=0;i<days;i++) {
                  const d = addDays(start, i);
                  const ds = isoDate(d);
                  const v = parseInt(localStorage.getItem(keysFor(id, ds).count) || "0", 10);
                  labels.push(ds.slice(5)); // MM-DD
                  values.push(isNaN(v)?0:v);
              }
              return { labels, values, startISO: isoDate(start), endISO: isoDate(end) };
          }

          // --- drawing ---
          function drawHistory() {
              const endISO = isoDate(addDays(new Date(todayStr()), -offsetDays));
              const { labels, values, startISO, endISO: eISO } = getHistoryWindow(endISO, WINDOW_DAYS);

              const dpr = window.devicePixelRatio || 1;
              const cssW = $chart.clientWidth, cssH = $chart.clientHeight;
              $chart.width = Math.round(cssW * dpr);
              $chart.height = Math.round(cssH * dpr);

              const ctx = $chart.getContext('2d');
              ctx.setTransform(dpr,0,0,dpr,0,0);
              ctx.clearRect(0,0,cssW,cssH);

              const pad = { l: 32, r: 8, t: 8, b: 24 };
              const w = cssW - pad.l - pad.r;
              const h = cssH - pad.t - pad.b;
              const maxV = Math.max(5, ...values);
              const barGap = 6;
              const barW = Math.max(4, (w - barGap*(values.length-1)) / values.length);
              pxPerDay = w / WINDOW_DAYS;

              // axes
              ctx.strokeStyle = 'rgba(255,255,255,0.15)';
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(pad.l, pad.t);
              ctx.lineTo(pad.l, pad.t + h);
              ctx.lineTo(pad.l + w, pad.t + h);
              ctx.stroke();

              // y ticks
              ctx.fillStyle = 'rgba(255,255,255,0.6)';
              ctx.font = '12px -apple-system, system-ui, Arial';
              ctx.textAlign = 'right';
              ctx.textBaseline = 'middle';
              ctx.fillText('0', pad.l - 6, pad.t + h);
              ctx.fillText(String(maxV), pad.l - 6, pad.t);

              // bars
              const startX = pad.l;
              ctx.fillStyle = '#6ea8fe';
              for (let i = 0; i < values.length; i++) {
                  const v = values[i];
                  const x = startX + i * (barW + barGap);
                  const bh = (v / maxV) * h;
                  const y = pad.t + h - bh;
                  ctx.fillRect(Math.round(x), Math.round(y), Math.round(barW), Math.round(bh));
              }

              // 7-day SMA trend line
              if (values.length >= 7) {
                  ctx.strokeStyle = 'rgba(251,191,36,0.7)';
                  ctx.lineWidth = 2;
                  ctx.beginPath();
                  let started = false;
                  for (let i = 6; i < values.length; i++) {
                      let sum = 0;
                      for (let j = i - 6; j <= i; j++) sum += values[j];
                      const avg = sum / 7;
                      const x = startX + i * (barW + barGap) + barW / 2;
                      const y = pad.t + h - (avg / maxV) * h;
                      if (!started) { ctx.moveTo(x, y); started = true; }
                      else ctx.lineTo(x, y);
                  }
                  ctx.stroke();
              }

              // x labels (sparse)
              ctx.fillStyle = 'rgba(255,255,255,0.6)';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'top';
              const step = Math.max(1, Math.ceil(labels.length / 5));
              for (let i = 0; i < labels.length; i += step) {
                  const x = startX + i * (barW + barGap) + barW / 2;
                  ctx.fillText(labels[i], Math.round(x), pad.t + h + 4);
              }

              // range label ‚Äî hint removed
              $label.textContent = `${startISO} ‚Üí ${eISO}`;
          }

          // --- interactions (reversed direction) ---
          let dragging = false;
          let startX = 0;

          $chart.addEventListener('pointerdown', (e) => {
              dragging = true;
              startX = e.clientX;
              $chart.setPointerCapture(e.pointerId);
              $chart.style.cursor = 'grabbing';
          });
          $chart.addEventListener('pointermove', (e) => {
              if (!dragging) return;
              const dx = e.clientX - startX;
              const deltaDays = Math.round(dx / pxPerDay);
              if (deltaDays !== 0) {
                  // reversed vs earlier version
                  offsetDays = clamp(offsetDays + deltaDays, 0, maxOffsetDays);
                  startX += deltaDays * pxPerDay;
                  drawHistory();
              }
          });
          function endDrag(e){
              if (!dragging) return;
              dragging = false;
              $chart.style.cursor = 'grab';
              try { $chart.releasePointerCapture(e.pointerId); } catch {}
          }
          $chart.addEventListener('pointerup', endDrag);
          $chart.addEventListener('pointercancel', endDrag);
          $chart.addEventListener('pointerleave', endDrag);

          // Wheel (Shift for horizontal on many systems). Reversed mapping.
          $chart.addEventListener('wheel', (e) => {
              e.preventDefault();
              const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
              offsetDays = clamp(offsetDays + (delta > 0 ? -3 : 3), 0, maxOffsetDays);
              drawHistory();
          }, {passive:false});

          // Keyboard: ‚Üê newer, ‚Üí older (reversed from earlier)
          const onKey = (e) => {
              if (e.key === 'ArrowLeft')  { offsetDays = clamp(offsetDays - 1, 0, maxOffsetDays); drawHistory(); }
              if (e.key === 'ArrowRight') { offsetDays = clamp(offsetDays + 1, 0, maxOffsetDays); drawHistory(); }
          };
          document.addEventListener('keydown', onKey);

          // init
          computeBounds();
          drawHistory();
          updateStats();
          addEventListener('resize', drawHistory, {passive:true});

          (function showSavedInit(){ $status.textContent='Saved'; $status.style.opacity='.7'; })();
      }

      /* ---------- ROUTER ---------- */
      function route() {
          const id = location.hash.replace(/^#/, '');
          if (id) renderDetail(id); else renderHome();
      }
      addEventListener('hashchange', route, {passive:true});
      route();
    </script>
  </body>
</html>
